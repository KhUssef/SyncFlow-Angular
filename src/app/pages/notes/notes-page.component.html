<div class="container" (click)="handleClickOutside($event)">
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebarHeader">
        <div>
          <p class="eyebrow">Notes</p>
          <h3>Pick a note</h3>
        </div>
      </div>

      <div class="createRow">
        <input
          type="text"
          placeholder="New note title"
          [ngModel]="newNoteTitle()"
          (ngModelChange)="newNoteTitle.set($event)"
          [disabled]="creatingNote()"
        />
        <button
          (click)="createNote()"
          [disabled]="creatingNote() || !newNoteTitle().trim()"
        >
          {{ creatingNote() ? 'Creating...' : 'Create' }}
        </button>
      </div>

      <div *ngIf="notesLoading()" class="muted">Loading notes…</div>
      <div *ngIf="!notesLoading() && !notes().length" class="muted">No notes yet. Create the first one.</div>

      <div class="noteList" *ngIf="notes().length">
        <div
          class="noteListItem"
          *ngFor="let note of notes()"
          [class.selected]="note.id === selectedNoteId()"
          (click)="selectNote(note.id)"
        >
          <div class="noteMeta">
            <div class="noteTitle">{{ note.title }}</div>
            <div class="noteSubtitle">{{ note.lineCount || 0 }} lines</div>
          </div>
          <span class="chevron">›</span>
        </div>
      </div>
    </aside>

    <section class="workspace">
      <div class="header">
        <div>
          <p class="eyebrow">Collaborative Notes</p>
          <h2>{{ selectedNoteTitle() }}</h2>
        </div>
        <div [class]="'connectionStatus ' + (isConnected() ? 'connected' : 'disconnected')">
          {{ isConnected() ? 'Connected' : 'Disconnected' }}
        </div>
        <div #styleMenuRef [class]="'styleMenu ' + (!getSelectedLineData() ? 'disabled' : '')">
          <div class="menuLabel">
            {{ getSelectedLineData() 
              ? 'Editing Line ' + selectedLine() 
                : 'Select a line to edit styling'
            }}
          </div>

          <div class="menuControl">
            <label>Size</label>
            <input
              type="number"
              min="8"
              max="72"
              [value]="getSelectedLineData()?.fontSize || 14"
              (change)="handleStyleChange('fontSize', $any($event.target).value)"
              class="menuInput"
              [disabled]="!getSelectedLineData()"
              style="width: 70px"
            />
          </div>

          <div class="menuControl">
            <label>Color</label>
            <input
              type="color"
              [value]="getSelectedLineData()?.color || '#000000'"
              (change)="handleStyleChange('color', $any($event.target).value)"
              class="colorInput"
              [disabled]="!getSelectedLineData()"
            />
          </div>

          <div 
            [class]="'highlightToggle ' + (getSelectedLineData()?.highlighted ? 'active' : '')"
            (click)="getSelectedLineData() && handleStyleChange('highlighted', !getSelectedLineData()?.highlighted)"
          >
            <input
              type="checkbox"
              [checked]="getSelectedLineData()?.highlighted || false"
              (change)="$event"
              class="checkbox"
              [disabled]="!getSelectedLineData()"
            />
            <span>Highlight</span>
          </div>
        </div>
      </div>

      <div *ngIf="error()" class="error">
        {{ error() }}
      </div>

      <div *ngIf="selectedNoteId() && !linesLoading(); else loadingState" class="noteLines">
        <div *ngFor="let line of noteLines(); trackBy: trackByLineNumber" 
             [class]="'noteLine ' + 
                      (getLineLockStatus(line.lineNumber).isLocked && !getLineLockStatus(line.lineNumber).isLockedByMe ? 'lockedLine' : '') +
                      (selectedLine() === line.lineNumber ? ' selected' : '') +
                      (line.highlighted ? ' highlighted' : '')"
             (click)="!getLineLockStatus(line.lineNumber).isLocked && handleLineFocus(line.lineNumber)">
          
          <div class="lineNumber">{{ line.lineNumber }}</div>

          <div class="lineContent">
            <textarea
              #textarea
              (focus)="registerTextareaRef(line.lineNumber, textarea); handleLineFocus(line.lineNumber)"
              [style.fontSize]="(line.fontSize || 14) + 'px'"
              [style.color]="line.color || '#000000'"
              class="textarea"
              [value]="line.content || ''"
              [disabled]="!getLineLockStatus(line.lineNumber).canEdit"
              [placeholder]="getLineLockStatus(line.lineNumber).isLocked && !getLineLockStatus(line.lineNumber).isLockedByMe
                ? 'Locked by ' + getLineLockStatus(line.lineNumber).lockedBy
                : 'Enter text...'"
              (input)="handleContentChange(line.lineNumber, $any($event.target).value)"
            ></textarea>

            <div *ngIf="getLineLockStatus(line.lineNumber).isLocked" class="lockIndicator">
              {{ getLineLockStatus(line.lineNumber).isLockedByMe
                  ? 'Editing...'
                  : 'Locked by ' + getLineLockStatus(line.lineNumber).lockedBy
              }}
            </div>
          </div>
        </div>
      </div>

      <ng-template #loadingState>
        <div class="loadingState">
          <p *ngIf="linesLoading()">Loading lines…</p>
          <p *ngIf="!selectedNoteId()">Select or create a note to get started.</p>
        </div>
      </ng-template>

      <div class="tips">
        <p>Tips:</p>
        <ul>
          <li>Use the sidebar to switch notes or create a new one</li>
          <li>Click on any line to start editing</li>
          <li>Use the style menu to change size, color, and highlighting</li>
          <li>Click outside the current line to unlock</li>
        </ul>
      </div>
    </section>
  </div>
</div>
